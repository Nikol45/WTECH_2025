<?php

namespace App\Http\Controllers;

use App\Models\Article;
use App\Models\Farm;
use App\Models\Review;
use App\Models\Address;
use App\Models\Company;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;

class ProfileController extends Controller
{
    /* ======================== DASHBOARD ======================== */

    public function index()
    {
        $user = Auth::user()->load([
            'billingAddress',
            'deliveryAddress',
            'company',
        ]);        if (! $user) {
            return redirect()->route('homepage');
        }

        // re≈æim zobrazenia: customer / admin
        $view = session('profile_view', 'customer');

        // odznak podƒæa poƒçtu recenzi√≠
        $reviewCount  = Review::where('user_id', $user->id)->count();
        $thresholds   = [
            0   => ['üå±', 'Nov√°ƒçik'],
            1   => ['ü•ö', 'Zaƒçiatoƒçn√≠k'],
            5   => ['ü™¥', 'Oceniteƒæ chut√≠'],
            15  => ['üß∫', 'Sk√∫sen√Ω ochutn√°vaƒç'],
            30  => ['üêì', 'Miestny odpor√∫ƒçaƒç'],
            50  => ['üçØ', 'Gurm√°nsky prieskumn√≠k'],
            100 => ['üèÜ', 'Znalec Slovenska'],
        ];

        $badgeIcon = $badgeName = null;
        foreach ($thresholds as $t => $info) {
            if ($reviewCount >= $t) [$badgeIcon, $badgeName] = $info;
            else break;
        }
        $nextT = collect(array_keys($thresholds))
            ->first(fn ($t) => $t > $reviewCount) ?? $reviewCount;

        $user->badge_icon    = $badgeIcon;
        $user->badge_name    = $badgeName;
        $user->badge_current = $reviewCount;
        $user->badge_target  = $nextT;

        $data = compact('user', 'view') + ['active' => 'index'];

        if ($user->is_admin) {
            $data['farms']    = Farm::whereUserId($user->id)->get();
            $data['articles'] = Article::whereUserId($user->id)->get();
            $data['reviews']  = Review::whereUserId($user->id)
                ->with('farm_product')
                ->latest()
                ->take(5)
                ->get();
        }

        return view('profile.index', $data);
    }

    /* ======================== PREP√çNAƒå RE≈ΩIMU ======================== */

    public function viewAsAdmin()
    {
        $user = Auth::user();
        session(['profile_view' => $user?->is_admin ? 'admin' : 'customer']);
        return redirect()->route('profile.index');
    }

    public function viewAsCustomer()
    {
        session(['profile_view' => 'customer']);
        return redirect()->route('profile.index');
    }

    /* ======================== UPDATE M√âTODY ======================== */

    public function updateName(Request $request)
    {
        $request->validate(['name' => 'required|string|max:255']);
        $request->user()->update(['name' => $request->name]);
        return back()->with('success', 'Meno bolo upraven√©.');
    }

    public function updateEmail(Request $request)
    {
        $request->validate([
            'email' => [
                'required', 'email', 'max:255',
                Rule::unique('users')->ignore($request->user()->id),
            ],
        ]);
        $request->user()->update(['email' => $request->email]);
        return back()->with('success', 'Email bol upraven√Ω.');
    }

    public function updatePhone(Request $request)
    {
        $request->validate([
            'phone_number' => 'required|string|min:4|max:32',
        ]);

        $raw = preg_replace('/\D+/', '', $request->phone_number); // len ƒç√≠sla

        // ak zaƒç√≠na 0, odstr√°≈à a pridaj +421
        if (str_starts_with($raw, '0')) {
            $raw = substr($raw, 1);
            $formatted = '+421 ' . substr($raw, 0, 3) . ' ' . substr($raw, 3, 3) . ' ' . substr($raw, 6);
        }
        // ak u≈æ zaƒç√≠na na 421, predpoklad√°me ≈æe je to slovensk√© ƒç√≠slo bez +
        elseif (str_starts_with($raw, '421')) {
            $raw = substr($raw, 3);
            $formatted = '+421 ' . substr($raw, 0, 3) . ' ' . substr($raw, 3, 3) . ' ' . substr($raw, 6);
        }
        // fallback ‚Äì len ƒç√≠sla (nezmen√≠ sa niƒç)
        else {
            $formatted = $request->phone_number;
        }

        $request->user()->update(['phone_number' => $formatted]);

        return back()->with('success', 'Telef√≥nne ƒç√≠slo bolo upraven√©.');
    }

    public function updatePassword(Request $request)
    {
        $request->validate([
            'current_password'      => 'required',
            'password'              => 'required|confirmed|min:8',
        ]);

        if (! Hash::check($request->current_password, $request->user()->password)) {
            return back()->withErrors(['current_password' => 'Nespr√°vne aktu√°lne heslo.']);
        }

        $request->user()->update(['password' => Hash::make($request->password)]);
        return back()->with('success', 'Heslo bolo zmenen√©.');
    }

    /* ---------- Adresy ---------- */

    public function updateBillingAddress(Request $request)
    {
        $data = $this->validateAddress($request);
        $this->upsertAddress($request->user(), 'billingAddress', $data);
        return back()->with('success', 'Fakturaƒçn√° adresa bola ulo≈æen√°.');
    }

    public function updateDeliveryAddress(Request $request)
    {
        $data = $this->validateAddress($request);
        $this->upsertAddress($request->user(), 'deliveryAddress', $data);
        return back()->with('success', 'Dodacia adresa bola ulo≈æen√°.');
    }

    /* ---------- Firma ---------- */

    public function updateCompany(Request $request)
    {
        $data = $request->validate([
            'name'    => 'required|string|max:255',
            'ico'     => 'required|string|max:32',
            'ic_dph'  => 'nullable|string|max:32',
        ]);

        $user = $request->user();

        // ak m√°, aktualizuj
        if ($user->company_id && $user->company) {
            $user->company->update($data);
        } else {
            // vytvor nov√∫ firmu
            $company = Company::create($data);
            $user->company_id = $company->id;
            $user->save();
        }

        return back()->with('success', 'Firemn√© √∫daje boli ulo≈æen√©.');
    }


    public function updateNickname(Request $r)
    {
        $r->validate(['nickname' => 'required|string|max:50']);
        $r->user()->update(['nickname' => $r->nickname]);
        return back()->with('success', 'Prez√Ωvka bola ulo≈æen√°.');
    }

    public function updateIcon(Request $r)
    {
        $r->validate(['icon_id' => 'required|exists:icons,id']);
        $r->user()->update(['icon_id' => $r->icon_id]);
        return back()->with('success', 'Avatar bol zmenen√Ω.');
    }

    public function createAdmin(Request $r)
    {
        $data = $r->validate([
            'name' => 'nullable|string|max:255',
        ]);

        $user = $r->user();

        if (!empty($data['name'])) {
            $user->name = $data['name'];
        }

        $user->is_admin = true;
        $user->save();

        return $this->viewAsAdmin();
    }


    /* ----------- ulo≈æenie farmy z modalu ----------- */
    public function storeFarm(Request $r)
    {
        $data = $r->validate([
            'name'           => 'required|string|max:255',
            'description'    => 'nullable|string',
            'image'          => 'nullable|image|max:2048',
            // adresa
            'street'         => 'required|string|max:255',
            'street_number'  => 'required|string|max:32',
            'city'           => 'required|string|max:255',
            'zip_code'       => 'required|string|max:16',
            'country'        => 'required|string|max:255',
        ]);

        // 1. adresa
        $address = Address::create([
            'street'        => $data['street'],
            'street_number' => $data['street_number'],
            'city'          => $data['city'],
            'zip_code'      => $data['zip_code'],
            'country'       => $data['country'],
            'address_type'  => 'farm',
        ]);

        // 2. farma
        $farm = Farm::create([
            'user_id'    => $r->user()->id,
            'address_id' => $address->id,
            'name'       => $data['name'],
            'description'=> $data['description'] ?? null,
        ]);

        // 3. obr√°zok ak existuje
        if ($r->hasFile('image')) {
            $path = $r->file('image')->store('farms', 'public');
            $farm->image()->create(['path' => $path]);
        }

        return back()->with('success', 'Farma bola pridan√°.');
    }


    /* ----------- ulo≈æenie ƒçl√°nku ----------- */
    public function storeArticle(Request $r)
    {
        $data = $r->validate([
            'title' => 'required|string|max:255',
            'text'  => 'required|string',
            'image' => 'nullable|image|max:2048',
        ]);

        // ƒçl√°nok bez obr√°zka
        $article = Article::create([
            'user_id' => $r->user()->id,
            'title'   => $data['title'],
            'text'    => $data['text'],
        ]);

        // ak bol nahran√Ω obr√°zok, priraƒè ho cez morphOne
        if ($r->hasFile('image')) {
            $path = $r->file('image')->store('articles', 'public');
            $article->image()->create(['path' => $path]);
        }

        return back()->with('success', 'ƒål√°nok bol pridan√Ω.');
    }


    /* ----------- ulo≈æenie recenzie ----------- */
    public function storeReview(Request $r)
    {
        $data = $r->validate([
            'farm_product_id' => 'required|exists:farm_products,id',
            'rating'          => 'required|integer|between:1,5',
            'content'         => 'required|string',
        ]);

        $data['user_id'] = $r->user()->id;

        Review::create($data);

        return back()->with('success', 'Recenzia bola pridan√°.');
    }

    public function replyToReview(Request $r, Review $review)
    {
        // overenie, ≈æe ide o farm√°ra danej farmy
        $this->authorize('reply', $review);

        $r->validate([
            'reply' => 'required|string|max:1000',
        ]);

        $review->reply = $r->input('reply');
        $review->save();

        return back()->with('success', 'Odpoveƒè bola ulo≈æen√°.');
    }


    /* ======================== POMOCN√â MET√ìDY ======================== */

    private function validateAddress(Request $request): array
    {
        return $request->validate([
            'street'        => 'required|string|max:255',
            'street_number' => 'required|string|max:32',
            'city'          => 'required|string|max:255',
            'zip_code'           => 'required|string|max:16',
            'country'       => 'required|string|max:255',
        ]);
    }

    private function upsertAddress($user, string $relation, array $data): void
    {
        $typeMap = [
            'billingAddress'  => 'billing',
            'deliveryAddress' => 'delivery',
        ];

        $data['address_type'] = $typeMap[$relation] ?? 'other';

        if ($user->$relation) {
            $user->$relation->update($data);
        } else {
            $address = Address::create($data);

            // nastav foreign key do users
            if ($relation === 'billingAddress') {
                $user->billing_address_id = $address->id;
            } elseif ($relation === 'deliveryAddress') {
                $user->delivery_address_id = $address->id;
            }

            $user->save();
        }
    }
}
